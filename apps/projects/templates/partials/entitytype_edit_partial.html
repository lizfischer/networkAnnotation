{% load form_fields %}

<form
        hx-post="{% if entity %}{% url 'projects:edit_entitytype' entity.id %}
            {% else %}{% url 'projects:add_entitytype' project.pk %}{% endif %}"
        hx-target="#entity-{% if entity %}{{ entity.id }}{% else %}new{% endif %}"
        hx-swap="outerHTML"
        class="border p-4 rounded mb-2 bg-base-200"
        id="entity-{{ entity.id }}"
        x-data="{
{#              fields: JSON.parse(document.getElementById('schema-json').textContent),#}
              fields: JSON.parse(document.getElementById('schema-json').textContent).map(f => {
                    if (f.type === 'dropdown' && f.choices) {
                        f.choices_str = f.choices.join('\n');
                    } else {
                        f.choices_str = '';
                    }
                    return f;
              }),
              addField() { this.fields.push({ name: '', label: '', type: '' }) },
              removeField(i) { this.fields.splice(i, 1) },
              prepareForSubmit() {
                    // Convert textarea options back to choices array
                    this.fields.forEach(f => {
                        if (f.type === 'dropdown') {
                            f.choices = f.choices_str.split('\n').map(s => s.trim()).filter(Boolean);
                        }
                        delete f.choices_str;
                    });
                }
            }"
        @submit.prevent="
            prepareForSubmit();
            $el.querySelector('input[name=schema]').value = JSON.stringify(fields);
          "
>
    <script id="schema-json" type="application/json">
        {{ schema_json|default:"[]"|safe }}
    </script>
    {% csrf_token %}

    <fieldset>
        {% render_field form.name %}
        {% render_field form.description %}
    </fieldset>

    <template x-for="(field, i) in fields" :key="i">
        <fieldset class="border p-3 mb-3 rounded bg-gray-50">

            <div class="flex justify-between items-center">
                <span>
{#                    {% include "form_parts/field_select.html" with options=field_types xmodel="field.type" label="Type" %}#}
                    <select x-model="field.tyhpe" class=" select w-full focus-within:outline-hidden">
                        <option disabled value="">Type</option>
                        {% for o in field_types %}
                            <option value="{{ o }}">{{ o|capfirst }}</option>
                        {% endfor %}
                    </select>
                </span>
                <button @click="removeField(i)" type="button" class="text-red-500 text-sm">âœ•</button>
            </div>

            <!-- common metadata -->
            <label class="block mt-2">Name</label>
            <input x-model="field.name" class=" input input-bordered w-full focus-within:outline-hidden">

            <label class="block mt-2">Label</label>
            <input x-model="field.label" class=" input input-bordered w-full focus-within:outline-hidden">


            <label class="block mt-2">Required?</label>
            <input x-model="field.required" type="checkbox" class="checkbox">

            <!-- type-specific options -->
            <template x-if="field.type === 'dropdown'">
                <div class="mt-3">
                    <label>Choices (one per line)</label>
                    <textarea x-model="field.choices_str"
                              class="textarea w-full focus-within:outline-hidden" rows="4"></textarea>
                </div>
            </template>

            <template x-if="field.type === 'reference'">
                <div class="mt-3">
                    <label>Entity type to reference</label>
                    <select x-model="field.default">
                        {% for t in entity_types %}
                            <option>{{ t.name|capfirst }}</option>
                        {% endfor %}
                    </select>
                </div>
            </template>
        </fieldset>
    </template>

    <button type="button" @click="addField()" class="btn btn-primary mt-4">+ Add Field</button>

    <!-- Bind hidden input to Alpine state -->
    <input type="hidden" name="schema" :value="JSON.stringify(fields)">


    <div class="mt-4">
        <button type="submit" class="btn btn-primary btn-sm">Save</button>
        {% if entity %}
            <button
                    type="button"
                    hx-get="{% url 'projects:entity_row' entity.id %}"
                    hx-target="#entity-{{ entity.id }}"
                    hx-swap="outerHTML"
                    class="btn btn-outline-neutral btn-sm"
            >
                Cancel
            </button>
        {% else %}
            <button type="button" class="btn btn-outline-neutral btn-sm" onclick="this.closest('form').remove()">
                Cancel
            </button>
        {% endif %}
    </div>
</form>

<script>
    setTimeout(() => {
        if (window.jscolor) jscolor.install();
    }, 100);
</script>